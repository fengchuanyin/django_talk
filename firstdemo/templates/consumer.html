<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Insight | AI 购物参谋（消费者版）</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.bootcdn.net/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <style>
        body {
            background-color: #0f1117;
            color: #ececf1;
            font-family: 'Segoe UI', Roboto, sans-serif;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        #hero-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
            transition: all 0.8s ease;
        }
        .brand-title {
            font-weight: 700;
            letter-spacing: 0.08em;
            background: linear-gradient(90deg, #8ab4f8 0%, #10a37f 100%);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-size: 44px;
        }
        .hero-search-wrapper { width: 100%; max-width: 680px; margin-top: 18px; }
        .hero-search-box {
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 16px;
            padding: 14px 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
        }
        .hero-input {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            color: #fff;
            font-size: 18px;
        }
        .hero-mic-btn {
            width: 42px; height: 42px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: #fff;
        }
        .hero-mic-btn:hover { background: rgba(255,255,255,0.15); }
        .hero-mic-btn.listening { background: rgba(16,163,127,0.25); border-color: #10a37f; color: #10a37f; }
        #chat-container {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            padding: 100px 24px 90px;
            display: none;
            overflow-y: auto;
        }
        .message-row { display: flex; gap: 12px; margin-bottom: 18px; }
        .message-row.user { justify-content: flex-end; }
        .avatar {
            width: 36px; height: 36px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            background: rgba(255,255,255,0.08); color: #fff;
        }
        .avatar.user { background: rgba(138,180,248,0.2); color: #8ab4f8; }
        .avatar.ai { background: rgba(16,163,127,0.2); color: #10a37f; }
        .bubble {
            max-width: 780px;
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 16px;
            padding: 14px 16px;
        }
        .rich-card {
            width: 100%;
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 16px;
            padding: 16px;
        }
        .product-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
        .score-box {
            margin-left: auto;
            background: rgba(16,163,127,0.2);
            color: #10a37f;
            border: 1px solid rgba(16,163,127,0.4);
            border-radius: 12px;
            padding: 6px 10px;
            font-weight: 700;
        }
        #input-area {
            position: fixed; bottom: 16px; left: 0; width: 100%;
            display: none; justify-content: center;
        }
        .bottom-search-box {
            width: 100%; max-width: 780px;
            display: flex; align-items: center; gap: 10px;
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 16px; padding: 12px 14px;
        }
        .bottom-input {
            flex: 1; background: transparent; border: none; outline: none; color: #fff; font-size: 16px;
        }
        .cursor {
            display: inline-block;
            width: 8px; height: 18px;
            background: #fff; opacity: 0.6;
            animation: blink 1s infinite;
            vertical-align: text-bottom;
            margin-left: 2px;
        }
        @keyframes blink { 0% {opacity: 0.6} 50% {opacity: 0} 100% {opacity: 0.6} }
        .history-sidebar { position: absolute; left: 24px; top: 120px; width: 280px; max-height: 60vh; overflow-y: auto; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.12); border-radius: 12px; padding: 12px; }
        .history-title { font-weight: 600; font-size: 14px; color: #fff; margin-bottom: 8px; }
        .history-item { display: flex; align-items: center; gap: 8px; padding: 8px; border-radius: 8px; cursor: pointer; }
        .history-item:hover { background: rgba(255,255,255,0.08); }
        .history-empty { color: #9ca3af; font-size: 13px; }
        .back-btn { position: fixed; top: 12px; left: 12px; z-index: 20; }
    </style>
</head>
<body>
    <div id="hero-layer">
        <a href="/merchant/" class="position-absolute top-0 end-0 m-3 btn btn-sm btn-outline-light">
            <i class="fas fa-briefcase me-1"></i>商家入口
        </a>
        <div id="compatBanner" class="position-absolute top-0 start-50 translate-middle-x mt-3 d-none">
            <div class="alert alert-warning py-2 px-3 mb-0 small">
                <i class="fas fa-exclamation-triangle me-1"></i>
                为使用语音输入，请在 Chrome 浏览器并允许麦克风权限；
                非本地环境需使用 HTTPS。
            </div>
        </div>
        <h1 class="brand-title">E-Insight</h1>
        <div class="hero-search-wrapper">
            <div class="hero-search-box">
                <input type="text" class="hero-input" id="heroInput" placeholder="粘贴京东链接，或说“iPhone 15”..." onkeydown="handleHeroEnter(event)" autocomplete="off">
                <button class="hero-mic-btn" id="heroMic" onclick="startHeroVoice()"><i class="fas fa-microphone"></i></button>
            </div>
            <div class="text-center mt-3 text-white-50 small">
                <i class="fas fa-bolt me-1 text-warning"></i>AI 实时爬虫驱动
            </div>
        </div>
        <div id="historySidebar" class="history-sidebar">
            <div class="history-title">历史对话</div>
            <div id="historyList"></div>
        </div>
    </div>
    <button id="backBtn" class="btn btn-sm btn-outline-light back-btn d-none">返回</button>
    <div id="chat-container"></div>
    <div id="input-area">
        <div class="bottom-search-box">
            <input type="text" class="bottom-input" id="followUpInput" placeholder="继续追问..." onkeydown="handleFollowUp(event)">
            <button class="btn text-white-50" id="followUpMicBtn" onclick="startFollowUpVoice()"><i class="fas fa-microphone"></i></button>
        </div>
    </div>
    <script>
        const MOCK_DATA = {
            product: {
                title: "示例商品",
                img: "https://via.placeholder.com/48x48",
                price: ""
            },
            summaryText: "暂无真实数据，以下为示例总结。<br>✅ 优点：手感、接口、影像<br>⚠️ 避雷：发热、信号"
        };
        const heroLayer = document.getElementById('hero-layer');
        const chatContainer = document.getElementById('chat-container');
        const inputArea = document.getElementById('input-area');
        let recognitionHero = null;
        let recognitionFollow = null;
        let firstUseGuideShown = false;
        function showPermissionGuide() {
            if (firstUseGuideShown) return;
            firstUseGuideShown = true;
            const btn = document.getElementById('heroMic');
            const tip = document.createElement('div');
            tip.className = 'position-absolute';
            tip.style.top = (btn.getBoundingClientRect().top + window.scrollY - 10) + 'px';
            tip.style.left = (btn.getBoundingClientRect().left + window.scrollX + 50) + 'px';
            tip.innerHTML = '<div class="alert alert-info py-2 px-3 small mb-0"><i class="fas fa-microphone me-1"></i>浏览器将弹出麦克风权限提示，请选择允许</div>';
            document.body.appendChild(tip);
            setTimeout(() => tip.remove(), 3000);
        }
        function detectCompatibility() {
            const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            const insecure = !window.isSecureContext && !['localhost','127.0.0.1'].includes(location.hostname);
            if (!SR || insecure) {
                const banner = document.getElementById('compatBanner');
                if (banner) banner.classList.remove('d-none');
            }
        }
        function initSpeechRecognition() {
            const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SR) return;
            recognitionHero = new SR();
            recognitionHero.continuous = false;
            recognitionHero.lang = 'zh-CN';
            recognitionHero.onstart = () => {
                document.getElementById('heroMic').classList.add('listening');
                const input = document.getElementById('heroInput');
                input.placeholder = "正在聆听...";
            };
            recognitionHero.onend = () => {
                document.getElementById('heroMic').classList.remove('listening');
                const input = document.getElementById('heroInput');
                input.placeholder = "粘贴京东链接，或说“iPhone 15”...";
            };
            recognitionHero.onresult = (event) => {
                const transcript = event.results[0][0].transcript.replace(/[。，！？]/g, '');
                const input = document.getElementById('heroInput');
                input.value = transcript;
                startAnalysisFlow(transcript);
            };
            recognitionFollow = new SR();
            recognitionFollow.continuous = false;
            recognitionFollow.lang = 'zh-CN';
            recognitionFollow.onstart = () => {
                const btn = document.getElementById('followUpMicBtn');
                btn.classList.add('text-success');
            };
            recognitionFollow.onend = () => {
                const btn = document.getElementById('followUpMicBtn');
                btn.classList.remove('text-success');
            };
            recognitionFollow.onresult = (event) => {
                const transcript = event.results[0][0].transcript.replace(/[。，！？]/g, '');
                const followInput = document.getElementById('followUpInput');
                followInput.value = transcript;
                addMessage('user', transcript);
                runAiSequence(transcript);
                followInput.value = '';
            };
        }
        function handleFollowUp(e) {
            if (e.key === 'Enter' && e.target.value.trim()) {
                const q = e.target.value.trim();
                addMessage('user', q);
                e.target.value = '';
                runAiSequence(q);
            }
        }
        function handleHeroEnter(e) {
            if (e.key === 'Enter' && e.target.value.trim()) {
                startAnalysisFlow(e.target.value.trim());
            }
        }
        function startHeroVoice() {
            const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (SR && recognitionHero) {
                showPermissionGuide();
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    navigator.mediaDevices.getUserMedia({ audio: true }).catch(() => {});
                }
                recognitionHero.start();
            } else {
                const btn = document.getElementById('heroMic');
                const input = document.getElementById('heroInput');
                btn.classList.add('listening');
                input.placeholder = "正在聆听...";
                setTimeout(() => {
                    btn.classList.remove('listening');
                    const text = "帮我分析一下 iPhone 15";
                    input.value = text;
                    setTimeout(() => { startAnalysisFlow(text); }, 800);
                }, 1500);
            }
        }
        function startFollowUpVoice() {
            const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (SR && recognitionFollow) {
                showPermissionGuide();
                recognitionFollow.start();
            } else {
                const followInput = document.getElementById('followUpInput');
                const q = "续航怎么样？";
                followInput.value = q;
                addMessage('user', q);
                setTimeout(() => {
                    addMessage('ai', "续航表现中规中矩，建议搭配快充。");
                }, 1000);
                followInput.value = '';
            }
        }
        function startAnalysisFlow(userQuery) {
            heroLayer.style.transform = 'translateY(-100vh)';
            heroLayer.style.opacity = '0';
            setTimeout(() => {
                heroLayer.style.display = 'none';
                document.getElementById('backBtn').classList.remove('d-none');
                chatContainer.style.display = 'block';
                inputArea.style.display = 'flex';
                addMessage('user', userQuery);
                runAiSequence(userQuery);
            }, 500);
        }
        let lastAbort = null;
        function debounce(fn, delay=400) {
            let t = null;
            return (...args) => {
                if (t) clearTimeout(t);
                t = setTimeout(() => fn(...args), delay);
            };
        }
        async function fetchWithTimeout(url, options={}, timeout=6000) {
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), timeout);
            const opts = { ...options, signal: controller.signal };
            try {
                const res = await fetch(url, opts);
                clearTimeout(id);
                return res;
            } catch (e) {
                clearTimeout(id);
                throw e;
            }
        }
        async function runAiSequence(query) {
            const loadId = addLoading("正在搜索商品...");
            try {
                if (lastAbort) lastAbort.abort();
                lastAbort = new AbortController();
                const url = `/reviews/api/products/?search=${encodeURIComponent(query)}`;
                const res = await fetchWithTimeout(url, { signal: lastAbort.signal }, 8000);
                if (!res.ok) throw new Error('接口错误: ' + res.status);
                const data = await res.json();
                const items = Array.isArray(data.items) ? data.items : [];
                if (items.length === 0) {
                    updateLoading(loadId, "未在库中找到该商品");
                    await wait(600);
                    document.getElementById(loadId).remove();
                    addMessage('ai', '抱歉，当前数据库未收录该商品，请更换关键字或稍后再试。');
                    return;
                }
                const pid = items[0].id;
                const productTitle = items[0].name || query;
                updateLoading(loadId, "正在获取洞察数据...");
                const res2 = await fetchWithTimeout(`/reviews/api/product/${pid}/insight/`, {}, 8000);
                if (!res2.ok) throw new Error('接口错误: ' + res2.status);
                const detail = await res2.json();
                const chartData = detail.sentiment_pct || null;
                const keywords = detail.keywords || [];
                const total = detail.review_count || 0;
                const score = detail.score10 || '';
                const pros = Array.isArray(detail.pros) ? detail.pros : [];
                const cons = Array.isArray(detail.cons) ? detail.cons : [];
                const summary = `综合评分 ${score} / 10，评论数 ${total}。优点：${pros.join('、') || '暂无'}；缺点：${cons.join('、') || '暂无'}。`;
                document.getElementById(loadId).remove();
                addRichCard({ title: productTitle, chartData, keywords, score, total, pros, cons, recent: detail.recent_reviews || [] });
                await wait(300);
                addStreamMessage(summary);
                saveHistoryItem({ query, title: productTitle, pid, time: Date.now() });
            } catch (err) {
                updateLoading(loadId, "网络异常或服务繁忙，正在回退示例数据...");
                await wait(800);
                document.getElementById(loadId).remove();
                addRichCard();
                await wait(300);
                addStreamMessage();
            }
        }
        function loadHistory() {
            try { return JSON.parse(localStorage.getItem('ei_history') || '[]'); } catch(e) { return []; }
        }
        function saveHistoryItem(item) {
            const list = loadHistory();
            const it = { ...item, pinned: !!item.pinned };
            list.unshift(it);
            if (list.length > 50) list.length = 50;
            localStorage.setItem('ei_history', JSON.stringify(list));
        }
        function renderHistorySidebar() {
            const list = loadHistory().slice().sort((a,b) => {
                const pa = a.pinned ? 1 : 0, pb = b.pinned ? 1 : 0;
                if (pb !== pa) return pb - pa;
                return (b.time || 0) - (a.time || 0);
            });
            const box = document.getElementById('historyList');
            if (!box) return;
            box.innerHTML = '';
            if (!list.length) {
                const empty = document.createElement('div');
                empty.className = 'history-empty';
                empty.innerText = '暂无历史';
                box.appendChild(empty);
                return;
            }
            list.forEach((it) => {
                const row = document.createElement('div');
                row.className = 'history-item';
                row.dataset.query = it.query || '';
                row.innerHTML = `
                    <i class="fas fa-history text-white-50"></i>
                    <div style="flex:1">
                        <div class="text-white small">${it.title || it.query || ''}</div>
                        <div class="text-white-50 small">${new Date(it.time).toLocaleString()}</div>
                    </div>
                    <button class="btn btn-sm ${it.pinned ? 'btn-warning' : 'btn-outline-light'} pin"><i class="fas fa-thumbtack"></i></button>
                    <button class="btn btn-sm btn-outline-danger del"><i class="fas fa-trash"></i></button>
                `;
                row.onclick = () => {
                    const v = it.query || it.title || '';
                    const input = document.getElementById('heroInput');
                    input.value = v;
                    startAnalysisFlow(v);
                };
                const pinBtn = row.querySelector('.pin');
                const delBtn = row.querySelector('.del');
                if (pinBtn) pinBtn.onclick = (e) => { e.stopPropagation(); togglePin(it.time); };
                if (delBtn) delBtn.onclick = (e) => { e.stopPropagation(); deleteHistory(it.time); };
                box.appendChild(row);
            });
        }
        function togglePin(time) {
            const list = loadHistory();
            const idx = list.findIndex(x => x.time === time);
            if (idx >= 0) {
                list[idx].pinned = !list[idx].pinned;
                localStorage.setItem('ei_history', JSON.stringify(list));
                renderHistorySidebar();
            }
        }
        function deleteHistory(time) {
            const list = loadHistory().filter(x => x.time !== time);
            localStorage.setItem('ei_history', JSON.stringify(list));
            renderHistorySidebar();
        }
        function restoreHero() {
            chatContainer.style.display = 'none';
            inputArea.style.display = 'none';
            document.getElementById('backBtn').classList.add('d-none');
            heroLayer.style.display = 'flex';
            heroLayer.style.transform = 'translateY(0)';
            heroLayer.style.opacity = '1';
            chatContainer.innerHTML = '';
            renderHistorySidebar();
            const input = document.getElementById('heroInput');
            input.focus();
        }
        function addMessage(role, text) {
            const div = document.createElement('div');
            div.className = 'message-row ' + role;
            div.innerHTML = `
                <div class="avatar ${role}"><i class="fas fa-${role==='user'?'user':'robot'}"></i></div>
                <div class="bubble">${text}</div>
            `;
            chatContainer.appendChild(div);
            scrollToBottom();
        }
        function addLoading(text) {
            const id = 'load-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = 'message-row ai';
            div.innerHTML = `
                <div class="avatar ai"><i class="fas fa-bolt"></i></div>
                <div class="bubble text-white-50">
                    <i class="fas fa-circle-notch fa-spin me-2"></i><span>${text}</span>
                </div>
            `;
            chatContainer.appendChild(div);
            scrollToBottom();
            return id;
        }
        function updateLoading(id, text) {
            const el = document.getElementById(id);
            if (el) el.querySelector('span').innerText = text;
        }
        function addRichCard(payload) {
            const div = document.createElement('div');
            div.className = 'message-row ai';
            div.innerHTML = `
                <div class="avatar ai"><i class="fas fa-chart-pie"></i></div>
                <div class="rich-card">
                    <div class="product-header">
                        <img src="${MOCK_DATA.product.img}" style="width: 48px; border-radius: 4px;">
                        <div style="flex:1">
                            <div class="fw-bold text-white">${payload?.title || MOCK_DATA.product.title}</div>
                            <div class="small text-white-50">${MOCK_DATA.product.price}</div>
                        </div>
                        <div class="score-box">${payload?.score ?? '—'}</div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3"><div id="chart-pie" style="height:200px;"></div></div>
                        <div class="col-md-6 mb-3"><div id="chart-bar" style="height:200px;"></div></div>
                    </div>
                    <div class="mt-2 text-white-50 small">评论数：${payload?.total ?? '—'}</div>
                    <div class="row mt-2">
                        <div class="col-md-6">
                            <div class="text-white-50 small">优点</div>
                            <div class="bubble mt-1">${(payload?.pros || []).join('、') || '暂无'}</div>
                        </div>
                        <div class="col-md-6">
                            <div class="text-white-50 small">缺点</div>
                            <div class="bubble mt-1">${(payload?.cons || []).join('、') || '暂无'}</div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <div class="text-white-50 small mb-1">近期评论</div>
                        ${(payload?.recent || []).map(r => `
                            <div class="bubble mb-2">
                                <div class="small text-white-50">${r.author} · 评分${r.rating} · ${r.sentiment} · ${r.created_at}</div>
                                <div>${r.content}</div>
                            </div>
                        `).join('') || '<div class="bubble">暂无</div>'}
                    </div>
                </div>
            `;
            chatContainer.appendChild(div);
            scrollToBottom();
            if (payload && payload.keywords) {
                window.lastKeywords = payload.keywords;
            } else {
                window.lastKeywords = [];
            }
            setTimeout(() => initCharts(payload?.chartData), 100);
        }
        function addStreamMessage(textOverride) {
            const div = document.createElement('div');
            div.className = 'message-row ai';
            div.innerHTML = `
                <div class="avatar ai"><i class="fas fa-magic"></i></div>
                <div class="bubble">
                    <div id="typewriter"></div><span class="cursor"></span>
                </div>
            `;
            chatContainer.appendChild(div);
            scrollToBottom();
            const target = div.querySelector('#typewriter');
            const text = textOverride || MOCK_DATA.summaryText;
            let i = 0;
            const interval = setInterval(() => {
                if (text[i] === '<') {
                    const close = text.indexOf('>', i);
                    target.innerHTML += text.substring(i, close + 1);
                    i = close + 1;
                } else {
                    target.innerHTML += text[i];
                    i++;
                }
                chatContainer.scrollTo(0, chatContainer.scrollHeight);
                if (i >= text.length) {
                    clearInterval(interval);
                    div.querySelector('.cursor').remove();
                }
            }, 20);
        }
        function initCharts(chartData) {
            const pie = echarts.init(document.getElementById('chart-pie'));
            pie.setOption({
                title: { text: '情感分布', left:'center', textStyle:{color:'#aaa', fontSize:12} },
                tooltip: { trigger: 'item' },
                series: [{
                    type: 'pie', radius: ['40%', '70%'],
                    data: [
                        {value: chartData?.positive ?? 82, name:'推荐', itemStyle:{color:'#10a37f'}},
                        {value: chartData?.neutral ?? 10, name:'中立', itemStyle:{color:'#f59e0b'}},
                        {value: chartData?.negative ?? 8, name:'劝退', itemStyle:{color:'#ef4444'}}
                    ],
                    label: { show: false }
                }]
            });
            const bar = echarts.init(document.getElementById('chart-bar'));
            const kw = (window.lastKeywords || []).slice(0, 10);
            const labels = kw.map(k => k.text);
            const weights = kw.map(k => k.weight);
            bar.setOption({
                title: { text: '热词统计', left:'center', textStyle:{color:'#aaa', fontSize:12} },
                grid: {top:30, bottom:10, left:0, right:0, containLabel:true},
                xAxis: {show:false},
                yAxis: {type:'category', data: labels.length ? labels : ['手感','发热','Type-C'], axisLabel:{color:'#fff'}},
                series: [{type:'bar', data: weights.length ? weights : [100,90,80], itemStyle:{color:'#667eea', borderRadius:[0,5,5,0]}}]
            });
        }
        function scrollToBottom() { chatContainer.scrollTo(0, chatContainer.scrollHeight); }
        function wait(ms) { return new Promise(r => setTimeout(r, ms)); }
        document.addEventListener('DOMContentLoaded', () => {
            detectCompatibility();
            initSpeechRecognition();
            const b = document.getElementById('backBtn');
            if (b) b.onclick = restoreHero;
            renderHistorySidebar();
        });
    </script>
</body>
</html>

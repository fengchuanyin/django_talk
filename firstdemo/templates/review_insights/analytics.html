{% extends 'base.html' %}
{% load static %}

{% block title %}数据分析 - 电商评论洞察系统{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <h1 class="h3 mb-4 text-gray-800">数据分析</h1>
    </div>
    <div class="col-md-4">
        <form method="get" class="d-flex justify-content-end">
            <select name="product" class="form-select" onchange="this.form.submit()">
                <option value="">-- 所有产品 --</option>
                {% for p in products %}
                <option value="{{ p.id }}" {% if selected_product_id == p.id %}selected{% endif %}>
                    {{ p.name }}
                </option>
                {% endfor %}
            </select>
        </form>
    </div>
</div>

<!-- 产品口碑评分指南 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="chart-container">
            <h5 class="chart-title">
                <i class="fas fa-award me-2"></i>产品口碑评分指南
            </h5>
            <div class="d-flex flex-nowrap overflow-auto pb-3" style="gap: 1rem;">
                {% for guide in reputation_guides %}
                <div class="flex-shrink-0" style="width: 350px;">
                    <div class="card dashboard-card h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <strong class="text-truncate" title="{{ guide.product.name }}">{{ guide.product.name }}</strong>
                                <span class="badge bg-dark flex-shrink-0 ms-2">{{ guide.tier }}</span>
                            </div>
                            <div class="mb-3">
                                <div class="stat-number">{{ guide.score }}</div>
                                <div class="stat-label">综合口碑分（0-100）</div>
                            </div>
                            <div class="mb-3">
                                <div class="d-flex justify-content-between">
                                    <span class="badge bg-success">正面 {{ guide.sentiment.positive }}%</span>
                                    <span class="badge bg-danger">负面 {{ guide.sentiment.negative }}%</span>
                                    <span class="badge bg-secondary">中性 {{ guide.sentiment.neutral }}%</span>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-6">
                                    <h6 class="text-success mb-2">优点</h6>
                                    {% if guide.pros %}
                                        {% for p in guide.pros %}
                                            <span class="badge bg-light text-dark d-block mb-1 text-truncate" title="{{ p }}">{{ p }}</span>
                                        {% endfor %}
                                    {% else %}
                                        <span class="text-muted">暂无明显优点</span>
                                    {% endif %}
                                </div>
                                <div class="col-6">
                                    <h6 class="text-danger mb-2">缺点</h6>
                                    {% if guide.cons %}
                                        {% for c in guide.cons %}
                                            <span class="badge bg-light text-dark d-block mb-1 text-truncate" title="{{ c }}">{{ c }}</span>
                                        {% endfor %}
                                    {% else %}
                                        <span class="text-muted">暂无明显缺点</span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="mt-3 d-flex justify-content-between">
                                <a href="{% url 'review_insights:reviews' %}?product={{ guide.product.id }}" class="btn btn-outline-primary btn-sm flex-fill me-1">
                                    查看评论
                                </a>
                                <a href="{% url 'review_insights:product_report' guide.product.id %}" class="btn btn-primary btn-sm flex-fill ms-1">
                                    下载报告
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- 总体统计 -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card dashboard-card text-center">
            <div class="card-body">
                <div class="card-icon text-primary">
                    <i class="fas fa-comments"></i>
                </div>
                <div class="stat-number">{{ total_reviews }}</div>
                <div class="stat-label">总评论数</div>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card dashboard-card text-center">
            <div class="card-body">
                <div class="card-icon text-success">
                    <i class="fas fa-thumbs-up"></i>
                </div>
                <div class="stat-number">
                    {% for stat in sentiment_distribution %}
                        {% if stat.sentiment == 'positive' %}{{ stat.count }}{% endif %}
                    {% endfor %}
                </div>
                <div class="stat-label">正面评论</div>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card dashboard-card text-center">
            <div class="card-body">
                <div class="card-icon text-warning">
                    <i class="fas fa-star"></i>
                </div>
                <div class="stat-number">
                    {% for product in product_insights|slice:":1" %}
                        {{ product.avg_rating|floatformat:1 }}
                    {% endfor %}
                </div>
                <div class="stat-label">平均评分</div>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card dashboard-card text-center">
            <div class="card-body">
                <div class="card-icon text-info">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="stat-number">{{ products.count }}</div>
                <div class="stat-label">产品数量</div>
            </div>
        </div>
    </div>
</div>

<!-- 图表区域 -->
<div class="row">
    <!-- 情感分布饼图 -->
    <div class="col-lg-6">
        <div class="chart-container">
            <h5 class="chart-title">
                <i class="fas fa-chart-pie me-2"></i>整体情感分布
            </h5>
            <canvas id="overallSentimentChart" data-chart="sentiment"
                    data-chart-data='{
                        "values": [{% for stat in sentiment_distribution %}{{ stat.count }}{% if not forloop.last %}, {% endif %}{% endfor %}]
                    }'>
            </canvas>
        </div>
    </div>

    <!-- 产品评分对比 -->
    <div class="col-lg-6">
        <div class="chart-container">
            <h5 class="chart-title">
                <i class="fas fa-chart-bar me-2"></i>产品评分对比
            </h5>
            <canvas id="productRatingChart" data-chart="rating"
                    data-chart-data='{
                        "labels": [{% for insight in product_insights %}"{{ insight.product.name }}"{% if not forloop.last %}, {% endif %}{% endfor %}],
                        "values": [{% for insight in product_insights %}{{ insight.avg_rating }}{% if not forloop.last %}, {% endif %}{% endfor %}]
                    }'>
            </canvas>
        </div>
    </div>
</div>

<!-- 产品洞察详情 -->
<div class="row mt-4">
    <div class="col-12">
        <div class="chart-container">
            <h5 class="chart-title">
                <i class="fas fa-table me-2"></i>产品洞察详情
            </h5>
            <div class="d-flex flex-nowrap overflow-auto pb-3" style="gap: 1rem;">
                {% for insight in product_insights %}
                <div class="flex-shrink-0" style="width: 320px;">
                    <div class="card dashboard-card h-100 border">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <strong class="text-truncate" title="{{ insight.product.name }}">{{ insight.product.name }}</strong>
                                <span class="badge bg-primary">{{ insight.avg_rating|floatformat:1 }}/5</span>
                            </div>
                            
                            <div class="d-flex justify-content-between text-center mb-3">
                                <div>
                                    <div class="small text-muted">总评论</div>
                                    <div class="fw-bold">{{ insight.total_reviews }}</div>
                                </div>
                                <div>
                                    <div class="small text-muted">正面</div>
                                    <div class="fw-bold text-success">{{ insight.sentiment_distribution.positive|default:0 }}</div>
                                </div>
                                <div>
                                    <div class="small text-muted">负面</div>
                                    <div class="fw-bold text-danger">{{ insight.sentiment_distribution.negative|default:0 }}</div>
                                </div>
                                <div>
                                    <div class="small text-muted">中性</div>
                                    <div class="fw-bold text-secondary">{{ insight.sentiment_distribution.neutral|default:0 }}</div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <h6 class="small text-muted mb-2">常见话题</h6>
                                <div class="d-flex flex-wrap gap-1">
                                    {% for topic in insight.common_topics|slice:":5" %}
                                    <span class="badge bg-light text-dark">{{ topic }}</span>
                                    {% empty %}
                                    <span class="text-muted small">暂无话题</span>
                                    {% endfor %}
                                </div>
                            </div>

                            <div class="mt-auto">
                                <a href="{% url 'review_insights:reviews' %}?product={{ insight.product.id }}" 
                                   class="btn btn-sm btn-outline-primary w-100">
                                    <i class="fas fa-eye me-1"></i>查看评论
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="col-12 text-center py-4 text-muted">
                    <i class="fas fa-inbox fa-2x mb-2"></i>
                    <p>暂无产品洞察数据</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- 评论趋势分析 -->
<div class="row mt-4">
    <div class="col-12">
        <div class="chart-container">
            <h5 class="chart-title">
                <i class="fas fa-chart-line me-2"></i>评论趋势分析
            </h5>
            <canvas id="trendAnalysisChart" data-chart="trend"
                    data-chart-data='{
                        "labels": [{% for i in "12345678910"|make_list %}"{{ i }}月"{% if not forloop.last %}, {% endif %}{% endfor %}],
                        "values": [120, 150, 180, 220, 280, 320, 350, 380, 420, 450]
                    }'>
            </canvas>
        </div>
    </div>
</div>

<!-- 主题-情感矩阵 -->
<div class="row mt-4">
    <div class="col-lg-8">
        <div class="chart-container">
            <h5 class="chart-title">
                <i class="fas fa-layer-group me-2"></i>主题-情感矩阵
            </h5>
            <canvas id="topicSentimentChart" data-chart="topic"
                    data-chart-data='{
                        "labels": [{% for t in topic_matrix.labels %}"{{ t }}"{% if not forloop.last %}, {% endif %}{% endfor %}],
                        "pos": [{% for v in topic_matrix.pos %}{{ v }}{% if not forloop.last %}, {% endif %}{% endfor %}],
                        "neg": [{% for v in topic_matrix.neg %}{{ v }}{% if not forloop.last %}, {% endif %}{% endfor %}],
                        "neu": [{% for v in topic_matrix.neu %}{{ v }}{% if not forloop.last %}, {% endif %}{% endfor %}]
                    }'>
            </canvas>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="chart-container">
            <h5 class="chart-title">
                <i class="fas fa-lightbulb me-2"></i>省钱省时建议
            </h5>
            {% if consumer_advice %}
                <ul class="list-unstyled mb-0">
                    {% for a in consumer_advice %}
                        <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>{{ a }}</li>
                    {% endfor %}
                </ul>
            {% else %}
                <div class="text-muted">暂无显著建议</div>
            {% endif %}
        </div>
    </div>
</div>

<!-- 主题证据 -->
<div class="row mt-4">
    <div class="col-12">
        <div class="chart-container">
            <h5 class="chart-title">
                <i class="fas fa-clipboard-list me-2"></i>主题证据
            </h5>
            <div class="row">
                {% for ev in topic_evidence %}
                <div class="col-md-6 mb-3">
                    <div class="p-3 border rounded">
                        <strong class="d-block mb-2">{{ ev.label }}</strong>
                        {% for s in ev.samples %}
                            <p class="mb-2 text-muted">{{ s }}</p>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- 数据导出 -->
<div class="row mt-4">
    <div class="col-12">
        <div class="chart-container">
            <h5 class="chart-title">
                <i class="fas fa-download me-2"></i>数据导出
            </h5>
            <div class="row">
                <div class="col-md-6">
                    <p class="text-muted">导出分析报告和数据用于进一步分析</p>
                </div>
                <div class="col-md-6 text-end">
                    <button class="btn btn-outline-primary me-2" onclick="exportData('csv')">
                        <i class="fas fa-file-csv me-1"></i>导出CSV
                    </button>
                    <button class="btn btn-outline-success me-2" onclick="exportData('excel')">
                        <i class="fas fa-file-excel me-1"></i>导出Excel
                    </button>
                    <button class="btn btn-outline-info" onclick="exportData('pdf')">
                        <i class="fas fa-file-pdf me-1"></i>导出PDF报告
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 数据分析页面特定功能
function exportData(format) {
    // 模拟数据导出功能
    const button = event.target;
    const originalText = button.innerHTML;
    
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>导出中...';
    button.disabled = true;
    
    setTimeout(() => {
        button.innerHTML = originalText;
        button.disabled = false;
        
        // 显示成功消息
        const alert = document.createElement('div');
        alert.className = 'alert alert-success alert-dismissible fade show';
        alert.innerHTML = `
            <i class="fas fa-check-circle me-2"></i>
            数据导出成功！格式：${format.toUpperCase()}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        // 找到第一个图表容器并插入警告消息
        const firstChartContainer = document.querySelector('.chart-container');
        if (firstChartContainer) {
            firstChartContainer.parentNode.insertBefore(alert, firstChartContainer);
        }
        
        setTimeout(() => {
            alert.remove();
        }, 3000);
    }, 2000);
}

// 初始化图表
document.addEventListener('DOMContentLoaded', function() {
    console.log('Analytics page initializing...');
    
    try {
        ReviewInsights.initializeCharts();
        console.log('Charts initialized successfully');
    } catch (error) {
        console.error('Error initializing charts:', error);
    }
});
</script>
{% endblock %}